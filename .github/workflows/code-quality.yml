name: ğŸ” Code Quality & Security Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: '-Xmx2048m -XX:+EnableDynamicAgentLoading'

jobs:
  # ğŸ§ª Unit Tests & Basic Quality
  unit-tests:
    name: ğŸ§ª Unit Tests & Coverage
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Needed for SonarCloud
    
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: ğŸ§ª Run Unit Tests
      run: ./mvnw clean test -B
    
    - name: ğŸ“Š Generate Test Report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: ğŸ§ª Unit Test Results
        path: target/surefire-reports/*.xml
        reporter: java-junit
    
    - name: ğŸ“ˆ Upload Coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        file: target/site/jacoco/jacoco.xml
        flags: unittests
        name: unit-tests
        fail_ci_if_error: false

  # ğŸ” Static Analysis
  static-analysis:
    name: ğŸ” Static Code Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: ğŸ¨ Checkstyle Analysis
      run: ./mvnw checkstyle:check -B
      continue-on-error: true
    
    - name: ğŸ” PMD Analysis
      run: ./mvnw pmd:check -B
      continue-on-error: true
    
    - name: ğŸ“Š Upload PMD Results
      uses: jwgmeligmeyling/pmd-github-action@master
      if: always()
      with:
        path: target/pmd.xml
    
    - name: ğŸ” SpotBugs Analysis
      run: ./mvnw compile spotbugs:check -B
      continue-on-error: true

  # ğŸ§¬ Mutation Testing
  mutation-testing:
    name: ğŸ§¬ Mutation Testing
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: ğŸ§¬ Run Mutation Tests
      run: ./mvnw org.pitest:pitest-maven:mutationCoverage -B
      continue-on-error: true
    
    - name: ğŸ“Š Upload Mutation Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mutation-testing-report
        path: target/pit-reports/
        retention-days: 30
    
    - name: ğŸ“ˆ Comment Mutation Results
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          try {
            const report = fs.readFileSync('target/pit-reports/index.html', 'utf8');
            const mutationMatch = report.match(/(\d+)% <div class="coverage_bar"><div class="coverage_complete width-\d+"><\/div><div class="coverage_legend">(\d+)\/(\d+)<\/div>/);
            if (mutationMatch) {
              const [, percentage, killed, total] = mutationMatch;
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ§¬ Mutation Testing Results\n\n**Coverage:** ${percentage}% (${killed}/${total} mutations killed)\n\nğŸ“Š [View detailed report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
              });
            }
          } catch (error) {
            console.log('Could not read mutation report:', error.message);
          }

  # ğŸ”’ Security Analysis
  security-analysis:
    name: ğŸ”’ Security Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: ğŸ”’ OWASP Dependency Check
      run: |
        ./mvnw org.owasp:dependency-check-maven:check \
          -DfailBuildOnCVSS=7 \
          -DsuppressionsLocation=owasp-suppressions.xml
      continue-on-error: true
    
    - name: ğŸ“Š Upload Security Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-report
        path: target/dependency-check-report.html
        retention-days: 30
    
    - name: ğŸ” CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: java
    
    - name: ğŸ—ï¸ Autobuild
      uses: github/codeql-action/autobuild@v3
    
    - name: ğŸ” Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  # ğŸ³ Integration Tests
  integration-tests:
    name: ğŸ³ Integration Tests
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wallet_test
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: ğŸ³ Start Services
      run: docker-compose up -d mysql-primary mysql-replica kafka zookeeper redis
    
    - name: â³ Wait for Services
      run: |
        timeout 60 bash -c 'until docker-compose exec -T mysql-primary mysqladmin ping -h localhost --silent; do sleep 2; done'
        timeout 60 bash -c 'until docker-compose exec -T kafka kafka-topics --bootstrap-server localhost:9092 --list; do sleep 2; done'
    
    - name: ğŸ§ª Run Integration Tests
      run: ./mvnw verify -B -DskipITs=false
      env:
        QUARKUS_DATASOURCE_JDBC_URL: jdbc:mysql://localhost:3306/wallet_test
        QUARKUS_DATASOURCE_USERNAME: root
        QUARKUS_DATASOURCE_PASSWORD: root
    
    - name: ğŸ“Š Upload Integration Test Results
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: ğŸ³ Integration Test Results
        path: target/failsafe-reports/*.xml
        reporter: java-junit
    
    - name: ğŸ§¹ Cleanup
      if: always()
      run: docker-compose down -v

  # â˜ï¸ SonarCloud Analysis
  sonarcloud:
    name: â˜ï¸ SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [unit-tests, static-analysis]
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: ğŸ” Cache SonarCloud packages
      uses: actions/cache@v4
      with:
        path: ~/.sonar/cache
        key: ${{ runner.os }}-sonar
        restore-keys: ${{ runner.os }}-sonar
    
    - name: â˜ï¸ SonarCloud Scan
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        ./mvnw clean verify sonar:sonar \
          -Dsonar.projectKey=wallet-service \
          -Dsonar.organization=your-org \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml

  # ğŸ“Š Quality Gate
  quality-gate:
    name: ğŸ“Š Quality Gate
    runs-on: ubuntu-latest
    needs: [unit-tests, static-analysis, integration-tests]
    if: always()
    
    steps:
    - name: ğŸ“Š Check Quality Gate
      run: |
        echo "ğŸ” Quality Gate Results:"
        echo "Unit Tests: ${{ needs.unit-tests.result }}"
        echo "Static Analysis: ${{ needs.static-analysis.result }}"
        echo "Integration Tests: ${{ needs.integration-tests.result }}"
        
        if [[ "${{ needs.unit-tests.result }}" != "success" ]]; then
          echo "âŒ Unit tests failed"
          exit 1
        fi
        
        if [[ "${{ needs.integration-tests.result }}" != "success" ]]; then
          echo "âŒ Integration tests failed"
          exit 1
        fi
        
        echo "âœ… Quality gate passed!"

  # ğŸš€ Performance Testing (on main branch only)
  performance-testing:
    name: ğŸš€ Performance Testing
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [quality-gate]
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: ğŸ—ï¸ Build Application
      run: ./mvnw clean package -DskipTests -B
    
    - name: ğŸ³ Start Application
      run: |
        docker-compose up -d
        java -jar target/quarkus-app/quarkus-run.jar &
        sleep 30
    
    - name: ğŸ“¦ Setup K6
      uses: grafana/k6-action@v0.3.1
      with:
        filename: scripts/load-test-basic.js
    
    - name: ğŸ“Š Upload Performance Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-results
        path: performance-results.json
        retention-days: 30
